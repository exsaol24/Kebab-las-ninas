{# templates/inicio/index.html.twig #}
{% extends 'base.html.twig' %}

{% set page_css = 'inicio' %}

{% block title %}Inicio - Kebab Las Ni√±as{% endblock %}

{% block body %}

    <section class="banner" style="margin-top: 0;">
        <div class="banner-content">
            <h2>¬°El mejor sabor en cada bocado!</h2>
            <p>Disfruta de nuestros kebabs √∫nicos y deliciosos.</p>
            <a href="sobrenosotros" class="btn btn-primary">Con√≥cenos</a>
        </div>
        <div class="banner-image">
            <img src="{{ asset('img/sobrekebab1.png') }}" alt="Deliciosos Kebabs">
        </div>
    </section>

    {# Carrusel de Ofertas #}
    <section class="ofertas-carousel-section">
        <div class="ofertas-carousel-container">
            <div class="ofertas-carousel" id="ofertasCarousel">
                <div class="oferta-slide active">
                    <img src="{{ asset('img/oferta1.png') }}" alt="Oferta 1">
                    <div class="oferta-info">
                        <h3>2x1 en Kebabs Cl√°sicos</h3>
                        <p>¬°Solo los mi√©rcoles! Ven con un amigo y paga solo uno.</p>
                    </div>
                </div>
                <div class="oferta-slide">
                    <img src="{{ asset('img/oferta2.png') }}" alt="Oferta 2">
                    <div class="oferta-info">
                        <h3>Men√∫ Familiar</h3>
                        <p>4 kebabs + patatas + bebida grande por solo 19,90‚Ç¨.</p>
                    </div>
                </div>
                <div class="oferta-slide">
                    <img src="{{ asset('img/oferta3.png') }}" alt="Oferta 3">
                    <div class="oferta-info">
                        <h3>Bebida gratis</h3>
                        <p>Con cada kebab XL, ll√©vate una bebida gratis.</p>
                    </div>
                </div>
            </div>
            <button class="ofertas-carousel-btn prev" id="ofertasPrev">‚ùÆ</button>
            <button class="ofertas-carousel-btn next" id="ofertasNext">‚ùØ</button>
             <div class="ofertas-carousel-dots">
                <span class="ofertas-carousel-dot active" data-slide="0"></span>
                <span class="ofertas-carousel-dot" data-slide="1"></span>
                <span class="ofertas-carousel-dot" data-slide="2"></span>
            </div>
        </div>
    </section>

    {# Zona de mapa  #}
    <section class="ubicacion-section">
        <div class="ubicacion-container">
            <div class="ubicacion-info">
                <h2>¬øD√≥nde estamos?</h2>
                <p>
                    <strong>Av. Arias de Velasco, 58, 29601 Marbella, M√°laga</strong><br>
                    ¬°Ven a visitarnos y disfruta del mejor kebab de la ciudad!
                </p>
            </div>
            <div class="ubicacion-mapa">
                <iframe
                    src="https://www.google.com/maps?q=Av.+Arias+de+Velasco,+58,+29601+Marbella,+M%C3%A1laga&hl=es&output=embed"
                    width="400"
                    height="250"
                    style="border:0; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.15); width:100%;"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </div>
    </section>

    <section id="testimonials" class="testimonials">
        <h2>Lo que dicen nuestros clientes</h2>
        <div class="testimonials-grid">
            <div class="testimonial-card">
                <p>"¬°El mejor kebab que he probado! Definitivamente volver√©."</p>
                <span>- Albertito P√©rez</span>
            </div>
            <div class="testimonial-card">
                <p>"Excelente servicio y comida deliciosa. Muy recomendado."</p>
                <span>- Marina L√≥pez</span>
            </div>
            <div class="testimonial-card">
                <p>"Un lugar perfecto para disfrutar con amigos y familia."</p>
                <span>- Kevin Soto</span>
            </div>
        </div>
    </section>

    <section id="platos" class="platos">
        <h2>Nuestros Platos</h2>
        <div class="platos-grid">
            {% for plato in platos %}
                <div class="plato-card">
                    <img src="{{ asset('uploads/platos/' ~ plato.imagen) }}" alt="{{ plato.nombre }}" class="plato-imagen">
                    <div class="plato-info">
                        <h3 class="plato-nombre">{{ plato.nombre }}</h3>
                        <p class="plato-descripcion">{{ plato.descripcion }}</p>
                        <p class="plato-precio">{{ plato.precio | number_format(2, '.', ',') }} ‚Ç¨</p>
                        {% if app.session.get('user_name') is not null %}
                            <button class="btn btn-add-to-cart" onclick="abrirPersonalizacion({{ plato.id }}, '{{ plato.nombre|e('js') }}', '{{ plato.categoria.nombre|lower }}')">
                                A√±adir al carrito
                            </button>
                        {% else %}
                            <span class="btn btn-add-to-cart js-login-required"
                                data-login-message="Debes iniciar sesi√≥n para a√±adir productos al carrito.">
                                A√±adir al carrito
                            </span>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <p>No hay platos disponibles en este momento.</p>
            {% endfor %}
        </div>

        {# Modal de personalizaci√≥n #}
        <div id="personalizacion-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="cerrarPersonalizacion()">&times;</span>
                <h2 id="modal-titulo"></h2>
                <form id="personalizacion-form" method="post">
                    <div class="modal-cantidad">
                        <label for="modal-cantidad-input">Cantidad:</label>
                        <input type="number" id="modal-cantidad-input" name="cantidad" value="1" min="1" required>
                    </div>
                    <div id="modal-opciones"></div>
                    <div class="modal-botones">
                        <button type="submit" class="btn btn-success">A√±adir</button>
                        <button type="button" class="btn btn-secondary" onclick="cerrarPersonalizacion()">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
        <style>
            .modal {
                display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.4); justify-content: center; align-items: center;
            }
            .modal-content {
                background: #fff; padding: 2rem; border-radius: 16px; max-width: 350px; margin: auto; box-shadow: 0 4px 24px rgba(0,0,0,0.18);
                position: relative; animation: modalIn .2s;
            }
            @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            .close { position: absolute; right: 1rem; top: 1rem; font-size: 2rem; cursor: pointer; color: #888; }
            .modal-cantidad { margin-bottom: 1rem; }
            .modal-botones { display: flex; gap: 1rem; margin-top: 1rem; }
            #modal-opciones label { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 1.1em; }
            #modal-opciones input[type="checkbox"] { accent-color: #e67e22; width: 18px; height: 18px; }
        </style>
        <script>
            let currentPlatoId = null;
            let currentCategoria = null;
            function abrirPersonalizacion(platoId, platoNombre, categoria) {
                currentPlatoId = platoId;
                currentCategoria = categoria;
                document.getElementById('modal-titulo').textContent = platoNombre;
                document.getElementById('personalizacion-modal').style.display = 'flex';
                document.getElementById('personalizacion-form').action = '{{ path('app_carrito_agregar_personalizado', {'id': 'PLATO_ID'}) }}'.replace('PLATO_ID', platoId);

                // Opciones seg√∫n categor√≠a
                let opciones = '';
                if (categoria === 'kebabs' || categoria === 'falafel') {
                    opciones += '<label><input type="checkbox" name="personalizacion[cebolla]" value="1"> Cebolla</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[salsa_yogurt]" value="1"> Salsa yogurt</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[lechuga]" value="1"> Lechuga</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[tomate]" value="1"> Tomate</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[maiz]" value="1"> Ma√≠z</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[queso_feta]" value="1"> Queso feta</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[lombarda]" value="1"> Lombarda</label>';
                    opciones += '<label><input type="checkbox" name="personalizacion[salsa_picante]" value="1"> Salsa picante</label>';
                } else if (categoria === 'entrantes') {
                    opciones += '<label><input type="checkbox" name="personalizacion[salsa_blanca]" value="1"> Salsa blanca</label>';
                }
                document.getElementById('modal-opciones').innerHTML = opciones;
            }
            function cerrarPersonalizacion() {
                document.getElementById('personalizacion-modal').style.display = 'none';
                document.getElementById('personalizacion-form').reset();
            }
            // Cierra el modal si se hace click fuera del contenido
            window.onclick = function(event) {
                const modal = document.getElementById('personalizacion-modal');
                if (event.target === modal) {
                    cerrarPersonalizacion();
                }
            }

            // AJAX para a√±adir producto personalizado al carrito
            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('personalizacion-form');
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const action = form.action;
                    const formData = new FormData(form);

                    fetch(action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            cerrarPersonalizacion();
                            // Actualizar contador carrito en navbar
                            let cartCount = document.querySelector('.cart-count');
                            if (!cartCount) {
                                const cartLink = document.querySelector('.cart-icon-link');
                                if (cartLink) {
                                    cartCount = document.createElement('span');
                                    cartCount.className = 'cart-count';
                                    cartLink.appendChild(cartCount);
                                }
                            }
                            if (cartCount) {
                                cartCount.textContent = data.total_productos_carrito;
                                cartCount.style.display = data.total_productos_carrito > 0 ? 'inline-block' : 'none';
                            }
                        } else {
                            alert(data.message || 'Error al a√±adir al carrito.');
                        }
                    })
                    .catch(() => {
                        alert('Error de red al a√±adir al carrito.');
                    });
                });
            });
        </script>
    </section>

    {# Apartado de reserva de mesas #}
    <section id="reserva-mesas" class="reserva-mesas-section mejorada kebab-theme">
        <div class="reserva-bg-decor"></div>
        <div class="reserva-card kebab-theme">
            <h2>
                <span class="icono-mesa">üçΩÔ∏è</span>
                Reserva tu mesa
            </h2>
            <form id="reserva-form" class="reserva-form mejorada">
                <div class="input-group">
                    <label for="nombre"><span class="input-icon">üë§</span> Nombre</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="¬øC√≥mo te llamas?">
                </div>
                <div class="input-group">
                    <label for="telefono"><span class="input-icon">üìû</span> Tel√©fono</label>
                    <input type="tel" id="telefono" name="telefono" required pattern="[0-9]{9,}" placeholder="Ej: 612345678">
                </div>
                <div class="input-group">
                    <label for="personas"><span class="input-icon">üë•</span> N¬∫ de personas</label>
                    <input type="number" id="personas" name="personas" min="1" max="20" required placeholder="Ej: 4">
                </div>
                <div class="input-group">
                    <label for="fecha"><span class="input-icon">üìÖ</span> Fecha</label>
                    <input type="date" id="fecha" name="fecha" required>
                </div>
                <div class="input-group">
                    <label for="hora"><span class="input-icon">‚è∞</span> Hora</label>
                    <select id="hora" name="hora" required>
                        <!-- Opciones generadas por JS -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-reserva kebab-theme">Reservar mesa</button>
            </form>
            <div id="reserva-mensaje" class="reserva-mensaje"></div>
            <div class="reserva-decor-icon"><img src="{{ asset('img/logo2.png') }}" alt="Kebab" /></div>
        </div>
    </section>

    <footer id="contact" class="footer">
        <p>¬© 2025 Kebab Las Ni√±as. Todos los derechos reservados.</p>
        <p>Contacto: <a href="mailto:info@kebablasni√±as.com">info@kebablasni√±as.com</a></p>
        <p>S√≠guenos en nuestras redes sociales:</p>
        <div class="social-links">
            <a href="https://es-es.facebook.com/"><img src="{{ asset('img/facebook.png') }}" alt="Facebook"></a>
            <a href="https://www.instagram.com/kebab_lasninas/"><img src="{{ asset('img/instagram.png') }}" alt="Instagram"></a>
            <a href="https://x.com/"><img src="{{ asset('img/x.png') }}" alt="Twitter"></a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Carrusel de ofertas
            let currentOferta = 0;
            const slides = document.querySelectorAll('.oferta-slide');
            const totalOfertas = slides.length;
            const prevBtn = document.getElementById('ofertasPrev');
            const nextBtn = document.getElementById('ofertasNext');
            const dots = document.querySelectorAll('.ofertas-carousel-dot');

            function showOferta(idx) {
                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === idx);
                });
                 dots.forEach((dot, i) => {
                    dot.classList.toggle('active', i === idx);
                });
            }
            function nextOferta() {
                currentOferta = (currentOferta + 1) % totalOfertas;
                showOferta(currentOferta);
            }
            function prevOferta() {
                currentOferta = (currentOferta - 1 + totalOfertas) % totalOfertas;
                showOferta(currentOferta);
            }
            if (prevBtn && nextBtn) {
                prevBtn.addEventListener('click', prevOferta);
                nextBtn.addEventListener('click', nextOferta);
            }

            dots.forEach(dot => {
                dot.addEventListener('click', function() {
                    const slideIndex = parseInt(this.dataset.slide);
                    currentOferta = slideIndex;
                    showOferta(currentOferta);
                });
            });

            // Auto-slide cada 6 segundos
            setInterval(nextOferta, 6000);
            showOferta(currentOferta);

            // Manejo para usuarios no logueados
            const loginRequiredButtons = document.querySelectorAll('.js-login-required');
            loginRequiredButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const message = this.dataset.loginMessage || 'Debes iniciar sesi√≥n.';
                    alert(message);
                });
            });

            // AJAX para a√±adir al carrito
            const addToCartButtons = document.querySelectorAll('.js-add-to-cart');
            addToCartButtons.forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const platoId = this.dataset.platoId;
                    fetch('{{ path('app_carrito_agregar', {'id': 'PLATO_ID'}) }}'.replace('PLATO_ID', platoId), {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Plato a√±adido al carrito.');
                            // Actualizar contador carrito en navbar
                            let cartCount = document.querySelector('.cart-count');
                            if (!cartCount) {
                                // Buscar el enlace del carrito
                                const cartLink = document.querySelector('.cart-icon-link');
                                if (cartLink) {
                                    cartCount = document.createElement('span');
                                    cartCount.className = 'cart-count';
                                    cartLink.appendChild(cartCount);
                                }
                            }
                            if (cartCount) {
                                cartCount.textContent = data.total_productos_carrito;
                                cartCount.style.display = data.total_productos_carrito > 0 ? 'inline-block' : 'none';
                            }
                        } else {
                            alert(data.message || 'Error al a√±adir al carrito.');
                        }
                    })
                    .catch(() => {
                        alert('Error de red al a√±adir al carrito.');
                    });
                });
            });

            // Env√≠o AJAX
            document.getElementById('reserva-form').addEventListener('submit', function(e){
                e.preventDefault();
                const form = this;
                const formData = new FormData(form);
                const mensajeDiv = document.getElementById('reserva-mensaje');
                mensajeDiv.className = 'reserva-mensaje'; // Limpia clases previas

                fetch('{{ path('reserva_mesa') }}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        mensajeDiv.textContent = '¬°Reserva enviada! Nos pondremos en contacto contigo para confirmarla.';
                        mensajeDiv.classList.add('visible');
                        form.reset();
                    } else {
                        mensajeDiv.textContent = data.message || 'Error al reservar.';
                        mensajeDiv.classList.add('error', 'visible');
                    }
                })
                .catch(() => {
                    mensajeDiv.textContent = 'Error de red al reservar.';
                    mensajeDiv.classList.add('error', 'visible');
                });
            });
        });
    </script>

{% endblock %}